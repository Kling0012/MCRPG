name: Claude AI Coder

on:
  issues:
    types: [labeled]
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:

jobs:
  # --- Job 1: Issueã‚’è§£æ±ºã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã™ã‚‹ ---
  ai-fix:
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-fix')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: npmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-claude-integrated
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Claude Code ã¨ MCPã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm install -g @anthropic-ai/claude-code
          npm install -g @modelcontextprotocol/server-sequential-thinking
          npm install -g @modelcontextprotocol/server-open-websearch

      - name: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è‡ªå¾‹å®Ÿè¡Œ
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SYSTEM_PROMPT="ã€è‡ªå¾‹å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã€‘ã‚ãªãŸã¯éå¯¾è©±ç’°å¢ƒã®GitHub Actionsä¸Šã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚
          - äººé–“ã¨ã®ä¼šè©±ã¯ä¸å¯èƒ½ã§ã™ã€‚è³ªå•ã›ãšã€MCPãƒ„ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ã¦è‡ªå·±å®Œçµã—ã¦ãã ã•ã„ã€‚
          - è«–ç†çš„æ€è€ƒã«ã¯ 'sequential-thinking' ã‚’ã€èª¿æŸ»ã«ã¯ 'open-websearch' ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
          - ä¿®æ­£å¾Œã¯å¿…ãšãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã€PRã‚’ä½œæˆã—ã¦çµ‚äº†ã—ã¦ãã ã•ã„ã€‚
          - ä½œæ¥­å®Œäº†å¾Œã€å¿…ãš git push ã—ã¦ãã ã•ã„ã€‚"

          claude "$SYSTEM_PROMPT \n\n æŒ‡ç¤ºå†…å®¹: Issue #${{ github.event.issue.number }} ${{ github.event.issue.title }}" \
            --mcp "npx @modelcontextprotocol/server-sequential-thinking" \
            --mcp "npx @modelcontextprotocol/server-open-websearch" \
            --dangerously-skip-permissions \
            --yes

  # --- Job 2: ä½œæˆã•ã‚ŒãŸPRã‚’è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ ---
  ai-review:
    # botã«ã‚ˆã‚‹PRã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
    if: github.event_name == 'pull_request' && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Claude Codeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g @anthropic-ai/claude-code

      - name: PRæƒ…å ±ã®å–å¾—
        id: pr-info
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "base_ref=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          echo "head_ref=${{ github.head_ref }}" >> $GITHUB_OUTPUT

      - name: å·®åˆ†ã®å–å¾—
        id: diff
        run: |
          git fetch origin ${{ steps.pr-info.outputs.base_ref }}
          DIFF=$(git diff origin/${{ steps.pr-info.outputs.base_ref }} HEAD)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AIãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
        run: |
          REVIEW_PROMPT="ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®PRã®å·®åˆ†ã‚’åˆ†æã—ã€æ—¥æœ¬èªã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
          1. ãƒã‚°ã®å¯èƒ½æ€§
          2. å¯èª­æ€§
          3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
          4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          5. SOLIDåŸå‰‡ã®éµå®ˆ

          ## å‡ºåŠ›å½¢å¼
          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

          ### ğŸ”´ Criticalï¼ˆé‡å¤§ãªå•é¡Œï¼‰
          - ï¼ˆå•é¡ŒãŒã‚ã‚Œã°è¨˜è¿°ï¼‰

          ### ğŸŸ¡ Majorï¼ˆæ”¹å–„æ¨å¥¨ï¼‰
          - ï¼ˆå•é¡ŒãŒã‚ã‚Œã°è¨˜è¿°ï¼‰

          ### ğŸŸ¢ Minorï¼ˆè»½å¾®ãªå•é¡Œï¼‰
          - ï¼ˆå•é¡ŒãŒã‚ã‚Œã°è¨˜è¿°ï¼‰

          ### âœ… è‰¯ã„ç‚¹
          - ï¼ˆè‰¯ã‹ã£ãŸç‚¹ã‚’è¨˜è¿°ï¼‰

          ## å·®åˆ†:
          ${{ steps.diff.outputs.diff }}"

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å–å¾—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          claude "$REVIEW_PROMPT" \
            --dangerously-skip-permissions \
            --yes > /tmp/review_result.txt 2>&1

          # çµæœã‚’ç¢ºèª
          if [ -s /tmp/review_result.txt ]; then
            echo "review_result<<EOF" >> $GITHUB_OUTPUT
            cat /tmp/review_result.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ" > /tmp/review_result.txt
            echo "review_result<<EOF" >> $GITHUB_OUTPUT
            cat /tmp/review_result.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: GitHub PRã¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_BODY="${{ steps.review.outputs.review_result }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
          gh api \
            --method POST \
            /repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            -f body="$REVIEW_BODY"

      - name: Critical/Majorå•é¡ŒãŒã‚ã‚Œã°Issueã‚’ä½œæˆ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW="${{ steps.review.outputs.review_result }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Criticalã¾ãŸã¯MajorãŒå«ã¾ã‚Œã‚‹å ´åˆã«Issueã‚’ä½œæˆ
          if echo "$REVIEW" | grep -qE "ğŸ”´ Critical|ğŸŸ¡ Major"; then
            ISSUE_TITLE="ğŸ¤– AIãƒ¬ãƒ“ãƒ¥ãƒ¼: ${PR_TITLE} (#${PR_NUMBER}) - è¦ä¿®æ­£"
            ISSUE_BODY="## AIãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

            PR #${PR_NUMBER} ã€Œ${PR_TITLE}ã€ ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§é‡å¤§ãªå•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚

            ${{ steps.review.outputs.review_result }}

            ---
            - PR: #${PR_NUMBER}
            - è‡ªå‹•ä½œæˆè€…: Claude AI Coder"

            gh issue create \
              --title "$ISSUE_TITLE" \
              --body "$ISSUE_BODY" \
              --label "ai-fix,auto-generated"
          fi

  # --- Job 3: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã«å¯¾ã™ã‚‹AIä¿®æ­£ ---
  ai-fix-review-comment:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Claude Codeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install -g @anthropic-ai/claude-code

      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®å–å¾—
        id: comments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          COMMENTS=$(gh api /repos/${{ github.repository }}/pulls/${PR_NUMBER}/comments \
            --jq '.[] | select(.body | contains("ä¿®æ­£") or contains("fix") or contains("æ”¹å–„")) | .body' | head -5)

          if [ -n "$COMMENTS" ]; then
            echo "comments<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMENTS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: AIã«ã‚ˆã‚‹ä¿®æ­£å®Ÿè¡Œ
        if: steps.comments.outputs.comments != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PROMPT="ã€PRä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã€‘ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…ƒã«ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
          ä¿®æ­£å¾Œã¯ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ:
          ${{ steps.comments.outputs.comments }}"

          claude "$PROMPT" \
            --dangerously-skip-permissions \
            --yes
