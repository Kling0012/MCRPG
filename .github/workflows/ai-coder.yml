name: Claude AI Coder

on:
  workflow_dispatch:
  push:
    branches:
      - Local50
      - main
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  id-token: write
  pull-requests: write
  issues: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build
        id: build
        continue-on-error: true
        run: |
          mvn clean package -Dmaven.test.skip=true -B 2>&1 | tee build.log
          BUILD_EXIT=${PIPESTATUS[0]}
          echo "build_exit_code=$BUILD_EXIT" >> $GITHUB_OUTPUT
          exit $BUILD_EXIT

      - name: Compile Check
        id: compile
        continue-on-error: true
        run: |
          if [ -f build.log ]; then
            mvn compile -B 2>&1 | tee -a build.log
          else
            mvn compile -B 2>&1 | tee build.log
          fi

      - name: Build Summary
        if: always()
        run: |
          echo "## ğŸ” ãƒ“ãƒ«ãƒ‰çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compile | ${{ steps.compile.outcome == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### æˆæœç‰©" >> $GITHUB_STEP_SUMMARY
            ls -lh target/*.jar 2>/dev/null | awk '{print "- **" $9 "**: " $5}' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 1

      - name: Upload build results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-results
          path: |
            target/*.jar
            !*sources.jar
            !*javadoc.jar
          retention-days: 1
          if-no-files-found: ignore

  ai-review:
    name: AI Review
    runs-on: ubuntu-latest
    needs: build
    if: |
      always() &&
      (github.event_name == 'pull_request_target') &&
      github.actor != 'github-actions[bot]' &&
      github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: read
      id-token: write
      pull-requests: write
      issues: write
    env:
      ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
      ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
      GH_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ github.token }}
      GITHUB_TOKEN: ${{ github.token }}
      CLAUDE_CODE_VERSION: 2.1.9
      BUILD_OUTCOME: ${{ needs.build.result }}

    steps:
      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            ~/.cache/bun
          key: ${{ runner.os }}-bun

      - name: Cache Claude Code
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/bin/claude
            ~/.claude
          key: ${{ runner.os }}-claude-code-${{ env.CLAUDE_CODE_VERSION }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build log
        uses: actions/download-artifact@v4
        with:
          name: build-log
          path: .
          continue-on-error: true

      - name: Claude AI Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CUSTOM_API_KEY }}
          github_token: ${{ github.token }}
          show_full_output: ${{ vars.CLAUDE_SHOW_FULL_OUTPUT == 'true' }}
          track_progress: true
          use_sticky_comment: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR BRANCH: ${{ github.event.pull_request.head.ref }}
            BASE BRANCH: ${{ github.event.pull_request.base.ref }}
            PR URL: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}

            ## ãƒ“ãƒ«ãƒ‰æ¤œè¨¼çµæœ
            - Build Outcome: ${{ needs.build.result }}
            - Build: ${{ needs.build.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}

            ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦æ—¥æœ¬èªã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
            ãƒ“ãƒ«ãƒ‰å¤±æ•—æ™‚ã¯ã€build.logã‚’ç¢ºèªã—ã¦å¤±æ•—åŸå› ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

            å¿…é ˆè¦ä»¶:
            - `gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }}` ã¨ `gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }}` ã‚’ä½¿ã£ã¦å¤‰æ›´å†…å®¹/æ–‡è„ˆã‚’æŠŠæ¡ã™ã‚‹
            - build.logãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ `cat build.log` ã§ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹
            - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ `gh pr review ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --comment -b "<æœ¬æ–‡>"` ã§PRã«ç›´æ¥æŠ•ç¨¿ã™ã‚‹

            - æŒ‡æ‘˜ãŒã‚ã‚‹å ´åˆã¯ã€é‡å¤§åº¦ã«é–¢ä¿‚ãªã Issue ã‚’è‡ªå‹•ä½œæˆã—ã¦ï¼ˆ`ai-fix,auto-generated` ãƒ©ãƒ™ãƒ«ä»˜ä¸ï¼‰
              - ai-issue-fix ãŒè‡ªå‹•å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã€Issueæœ¬æ–‡ã®å…ˆé ­ã«ä»¥ä¸‹ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’å¿…ãšå«ã‚ã‚‹:
                ---
                PR_NUMBER: ${{ github.event.pull_request.number }}
                PR_BRANCH: ${{ github.event.pull_request.head.ref }}
                BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
                FIX_MODE: update_pr
                PR_URL: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}
                ---
              - æœ¬æ–‡ã«ã¯ã€Œä¿®æ­£ã™ã¹ãé …ç›®ã€ã€Œæ¨å¥¨ä¿®æ­£æ–¹é‡ã€ã€Œå½±éŸ¿ç¯„å›²ã€ï¼ŒæŒ‡æ‘˜ç®‡æ‰€ã®è¡Œæ•°å‰å¾Œå¼•ç”¨ã‚’å«ã‚ã‚‹
            - æŒ‡æ‘˜ãŒã€Œç„¡ã„ã€å ´åˆã¯ Issue ã‚’ä½œæˆã—ãªã„

            ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:
            1. ãƒã‚°ã®å¯èƒ½æ€§
            2. å¯èª­æ€§
            3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
            5. SOLIDåŸå‰‡
            6. ä»–å±é™ºæ€§ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰

            PRã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã®æ§‹æˆ:
            - è¦‹å‡ºã—: Critical / Major / Minor / è‰¯ã„ç‚¹
            - å¿…ãšè©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ã¨å‰å¾Œè¡Œã®æ ¹æ‹ ã‚’æ·»ãˆã‚‹
          claude_args: |
            --dangerously-skip-permissions
            --allowedTools "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr review:*),Bash(gh issue create:*),Bash(gh issue edit:*),Bash(gh issue comment:*),Bash(gh api:*),Bash(cat build.log:*)"

  auto-merge:
    name: Auto Merge
    runs-on: ubuntu-latest
    needs: [build, ai-review]
    if: |
      always() &&
      (github.event_name == 'pull_request_target') &&
      github.actor != 'github-actions[bot]' &&
      github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: write
      pull-requests: write
      issues: write
    env:
      GH_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ github.token }}
      GITHUB_TOKEN: ${{ github.token }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
      PR_BASE_REF: ${{ github.event.pull_request.base.ref }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Check build and review status
        id: check
        run: |
          echo "Build result: ${{ needs.build.result }}"
          echo "AI Review result: ${{ needs.ai-review.result }}"

          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ Build failed. Skipping auto-merge."
            echo "can_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "${{ needs.ai-review.result }}" != "success" ]; then
            echo "âŒ AI Review failed. Skipping auto-merge."
            echo "can_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if any issues were created for this PR
          ISSUES=$(gh issue list \
            --search "auto-generated PR_NUMBER:${{ github.event.pull_request.number }} in:title" \
            --json number \
            --jq '. | length' \
            --limit 100 2>/dev/null || echo "0")

          if [ "$ISSUES" -gt 0 ]; then
            echo "âš ï¸ Found $ISSUES issue(s) for this PR. Skipping auto-merge."
            echo "can_merge=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… No issues found. Can proceed with auto-merge."
            echo "can_merge=true" >> $GITHUB_OUTPUT
          fi

      - name: Check PR mergeability
        id: mergeable
        if: steps.check.outputs.can_merge == 'true'
        run: |
          MERGEABLE=$(gh pr view ${{ github.event.pull_request.number }} \
            --json mergeable \
            --jq '.mergeable')

          if [ "$MERGEABLE" == "true" ]; then
            echo "âœ… PR is mergeable"
            echo "is_mergeable=true" >> $GITHUB_OUTPUT
          elif [ "$MERGEABLE" == "false" ]; then
            echo "âš ï¸ PR has conflicts. Will attempt to resolve."
            echo "is_mergeable=false" >> $GITHUB_OUTPUT
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
          else
            echo "â³ PR mergeability is being evaluated. Skipping."
            echo "is_mergeable=false" >> $GITHUB_OUTPUT
          fi

      - name: Resolve conflicts by rebase
        if: steps.mergeable.outputs.has_conflicts == 'true'
        run: |
          echo "ğŸ”§ Attempting to resolve conflicts by rebasing..."

          # Fetch all branches
          git fetch origin ${{ env.PR_BASE_REF }}
          git fetch origin ${{ env.PR_HEAD_REF }}

          # Checkout the PR branch
          git checkout ${{ env.PR_HEAD_REF }}

          # Rebase onto base branch
          if git rebase origin/${{ env.PR_BASE_REF }}; then
            echo "âœ… Rebase successful"

            # Force push the rebased branch
            git push origin ${{ env.PR_HEAD_REF }} --force-with-lease

            # Wait a moment for GitHub to update
            sleep 5

            # Check if PR is now mergeable
            MERGEABLE=$(gh pr view ${{ env.PR_NUMBER }} \
              --json mergeable \
              --jq '.mergeable')

            if [ "$MERGEABLE" == "true" ]; then
              echo "âœ… PR is now mergeable after rebase"
              echo "REBASE_SUCCESS=true" >> $GITHUB_ENV
            else
              echo "âš ï¸ PR still has conflicts after rebase"
              gh pr comment ${{ env.PR_NUMBER }} --body "âš ï¸ è‡ªå‹•rebaseã‚’å®Ÿè¡Œã—ã¾ã—ãŸãŒã€ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒè§£æ±ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§ã®è§£æ±ºãŒå¿…è¦ã§ã™ã€‚"
              echo "REBASE_SUCCESS=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ Rebase failed due to conflicts"
            gh pr comment ${{ env.PR_NUMBER }} --body "âš ï¸ è‡ªå‹•rebaseãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’æ‰‹å‹•ã§è§£æ±ºã—ã¦ãã ã•ã„ã€‚"
            echo "REBASE_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: Merge PR
        if: |
          (steps.check.outputs.can_merge == 'true' &&
           (steps.mergeable.outputs.is_mergeable == 'true' ||
            env.REBASE_SUCCESS == 'true'))
        run: |
          echo "ğŸ‰ Merging PR #${{ env.PR_NUMBER }}..."

          gh pr merge ${{ env.PR_NUMBER }} \
            --squash \
            --subject "Merge PR #${{ env.PR_NUMBER }} (auto-merged after AI review)" \
            --body "AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æŒ‡æ‘˜äº‹é …ãŒãªã‹ã£ãŸãŸã‚ã€è‡ªå‹•ãƒãƒ¼ã‚¸ã—ã¾ã—ãŸã€‚" \
            --delete-branch || {
            echo "âš ï¸ Merge failed. PR may require approval or have restrictions."
            gh pr comment ${{ env.PR_NUMBER }} --body "âš ï¸ è‡ªå‹•ãƒãƒ¼ã‚¸ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ«ãƒ¼ãƒ«ã‚„æ‰¿èªè¦ä»¶ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          }

      - name: Comment on successful merge
        if: success() && steps.check.outputs.can_merge == 'true'
        run: |
          if gh pr view ${{ env.PR_NUMBER }} --json state --jq '.state' | grep -q "CLOSED"; then
            echo "âœ… PR was successfully merged"
          fi
