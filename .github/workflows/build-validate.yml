# Mavenãƒ“ãƒ«ãƒ‰æ¤œè¨¼ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆæ™‚ã«ã®ã¿å®Ÿè¡Œ

name: Build & Validate

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  build:
    name: Mavenãƒ“ãƒ«ãƒ‰ & æ¤œè¨¼
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: JDK 21ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Mavenãƒ“ãƒ«ãƒ‰å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ—ï¼‰
        id: build
        run: mvn clean package -Dmaven.test.skip=true -B
        continue-on-error: true

      - name: ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã®è©³ç´°è¡¨ç¤º
        if: steps.build.outcome == 'failure'
        run: |
          echo "## âŒ ãƒ“ãƒ«ãƒ‰å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ã‚¨ãƒ©ãƒ¼è©³ç´°" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          mvn compile -X 2>&1 | grep -A5 "ERROR" >> $GITHUB_STEP_SUMMARY || echo "ã‚¨ãƒ©ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ãƒ“ãƒ«ãƒ‰å¤±æ•—æ™‚ã®å‡¦ç†
        if: steps.build.outcome == 'failure'
        run: exit 1

      - name: æˆæžœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: minecraft-plugin-jar
          path: target/*.jar
          retention-days: 7
          if-no-files-found: error

      - name: æˆæžœç‰©æƒ…å ±ã®è¡¨ç¤º
        run: |
          echo "## âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æˆæžœç‰©" >> $GITHUB_STEP_SUMMARY
          ls -lh target/*.jar 2>/dev/null | awk '{print "- **" $9 "**: " $5}' >> $GITHUB_STEP_SUMMARY

  compile-check:
    name: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¤œè¨¼
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: JDK 21ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ãƒ¡ã‚¤ãƒ³ã‚½ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¤œè¨¼
        id: compile
        run: mvn compile -B
        continue-on-error: true

      - name: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã®è©³ç´°è¡¨ç¤º
        if: steps.compile.outcome == 'failure'
        run: |
          echo "## âŒ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ã‚¨ãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§" >> $GITHUB_STEP_SUMMARY
          mvn compile 2>&1 | grep "\[ERROR\]" | awk -F':' '{print "- **" $1 "** (è¡Œ " $2 ")"}' | sort -u >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ã‚¨ãƒ©ãƒ¼è©³ç´°" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          mvn compile 2>&1 | grep -A3 "\[ERROR\]" >> $GITHUB_STEP_SUMMARY || echo "ã‚¨ãƒ©ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«å¤±æ•—æ™‚ã®å‡¦ç†
        if: steps.compile.outcome == 'failure'
        run: exit 1

      - name: æˆåŠŸæ™‚ã®è¡¨ç¤º
        if: steps.compile.outcome == 'success'
        run: |
          echo "## âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "ãƒ¡ã‚¤ãƒ³ã‚½ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã«æˆåŠŸã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY

  notify:
    name: çµæžœé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build, compile-check]
    if: always()

    steps:
      - name: çµæžœã®ã‚µãƒžãƒªãƒ¼
        run: |
          echo "## ðŸ” ãƒ“ãƒ«ãƒ‰çµæžœã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compile Check | ${{ needs.compile-check.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY

          # çµæžœã«å¿œã˜ã¦çµµæ–‡å­—
          if [ "${{ needs.build.result }}" == "success" ] && [ "${{ needs.compile-check.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ‰ å…¨ã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ã¾ã—ãŸï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ãŒã‚ã‚Šã¾ã™" >> $GITHUB_STEP_SUMMARY
          fi
