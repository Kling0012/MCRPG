name: Claude AI Coder

on:
  workflow_dispatch:
  push:
    branches:
      - Local50
      - main
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  ai-review:
    if: (github.event_name == 'pull_request_target') && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
      issues: write
    env:
      ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
      ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
      GH_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ github.token }}
      GITHUB_TOKEN: ${{ github.token }}
      CLAUDE_CODE_VERSION: 2.1.9

    steps:
      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            ~/.cache/bun
          key: ${{ runner.os }}-bun

      - name: Cache Claude Code
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/bin/claude
            ~/.claude
          key: ${{ runner.os }}-claude-code-${{ env.CLAUDE_CODE_VERSION }}

      - name: リポジトリのチェックアウト
        if: github.event_name != 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude に PR レビューを依頼（コメント投稿も含む）
        if: github.event_name != 'push' && github.event_name == 'pull_request_target'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CUSTOM_API_KEY }}
          github_token: ${{ github.token }}
          show_full_output: ${{ vars.CLAUDE_SHOW_FULL_OUTPUT == 'true' }}
          track_progress: true
          use_sticky_comment: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR BRANCH: ${{ github.event.pull_request.head.ref }}
            BASE BRANCH: ${{ github.event.pull_request.base.ref }}
            PR URL: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}

            あなたはシニアエンジニアです。このPRをレビューして日本語でフィードバックしてください。
            KISSの原則に従い、簡潔に具体的に指摘してください。
            必須要件:
            - `gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }}` と `gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }}` を使って変更内容/文脈を把握する
            - レビューは `gh pr review ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --comment -b "<本文>"` でPRに直接投稿する（`gh api /issues/.../comments` は使わない）

            - 指摘がある場合は、重大度に関係なく Issue を自動作成して（`ai-fix,auto-generated` ラベル付与）
              - ai-issue-fix が自動実行できるよう、Issue本文の先頭に以下のブロックを必ず含める:
                ---
                PR_NUMBER: ${{ github.event.pull_request.number }}
                PR_BRANCH: ${{ github.event.pull_request.head.ref }}
                BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
                FIX_MODE: update_pr
                PR_URL: ${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}
                ---
              - 本文には「修正すべき項目（チェックリスト）」「推奨修正方針」「影響範囲」を含める
            - 指摘が「無い」場合は Issue を作成しない（レビューコメントのみ投稿して終了）

            レビュー観点:
            1. バグの可能性
            2. 可読性
            3. パフォーマンス
            4. セキュリティ
            5. SOLID原則
            6. 他危険性のあるコード

            PRコメント本文の構成:
            - 見出し: Critical / Major / Minor / 良い点
            - 必ず該当ファイルと前後行の根拠を添える
          claude_args: |
            --dangerously-skip-permissions
            --allowedTools "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr review:*),Bash(gh issue create:*),Bash(gh issue edit:*),Bash(gh issue comment:*),Bash(gh api:*)"

  ai-fix-review-comment:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      pull-requests: write

    steps:
      - name: リポジトリのチェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: AIによる修正実行
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CUSTOM_API_KEY }}
          github_token: ${{ github.token }}
          show_full_output: ${{ vars.CLAUDE_SHOW_FULL_OUTPUT == 'true' }}
          prompt: |
            【PR修正モード】以下のレビューコメントを元にコードを修正してください。
            修正後はコミットしてプッシュしてください。

            ## レビューコメント:
            ${{ github.event.review.body }}
          claude_args: |
            --dangerously-skip-permissions
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
          GITHUB_TOKEN: ${{ github.token }}
