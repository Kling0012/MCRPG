name: Claude AI Coder

on:
  workflow_dispatch:
  push:
    branches:
      - Local50
      - main
  issues:
    types: [labeled]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  ai-fix:
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-fix') && !contains(github.event.issue.labels.*.name, 'auto-generated')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      issues: write
      pull-requests: write

    steps:
      - name: Claude ã« Issue å¯¾å¿œã‚’ä¾é ¼
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CUSTOM_API_KEY }}
          github_token: ${{ secrets.G_TOKEN }}
          show_full_output: true
          prompt: |
            ã€è‡ªå¾‹å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã€‘ã‚ãªãŸã¯éå¯¾è©±ç’°å¢ƒã® GitHub Actions ä¸Šã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚
            - äººé–“ã¨ã®ä¼šè©±ã¯ä¸å¯èƒ½ã§ã™ã€‚è³ªå•ã›ãšè‡ªå·±å®Œçµã—ã¦ãã ã•ã„ã€‚
            - ä¿®æ­£å¾Œã¯å¿…ãšãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã€PRã‚’ä½œæˆã—ã¦çµ‚äº†ã—ã¦ãã ã•ã„ã€‚
            - ä½œæ¥­å®Œäº†å¾Œã€å¿…ãš git push ã—ã¦ãã ã•ã„ã€‚

            æŒ‡ç¤ºå†…å®¹: Issue #${{ github.event.issue.number }} ${{ github.event.issue.title }}
          claude_args: |
            --dangerously-skip-permissions
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.G_TOKEN }}

  ai-review:
    if: (github.event_name == 'pull_request' || github.event_name == 'pull_request_target' || github.event_name == 'push') && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
      issues: write

    steps:
      - name: pushï¼ˆæ¤œè¨¼ç”¨ï¼‰
        if: github.event_name == 'push'
        run: |
          echo "pushã‚¤ãƒ™ãƒ³ãƒˆã¯æ¤œè¨¼ç”¨ã®èµ·å‹•ç¢ºèªã®ã¿ï¼ˆClaudeãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å®Ÿè¡Œã—ã¾ã›ã‚“ï¼‰"

      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        if: github.event_name != 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: jq ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: github.event_name != 'push'
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: GitHub CLI ã‚’ç¢ºèª
        if: github.event_name != 'push'
        run: |
          command -v gh >/dev/null 2>&1 || { echo "gh not found"; exit 1; }

      - name: Claude ã« PR ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ï¼ˆstructured outputï¼‰
        if: github.event_name != 'push' && (github.event_name == 'pull_request' || github.event_name == 'pull_request_target')
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CUSTOM_API_KEY }}
          github_token: ${{ secrets.G_TOKEN }}
          show_full_output: true
          prompt: |
            ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€æ—¥æœ¬èªã§ã‚³ãƒ¡ãƒ³ãƒˆæ–‡ã‚’ä½œã£ã¦ãã ã•ã„ã€‚

            ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:
            1. ãƒã‚°ã®å¯èƒ½æ€§
            2. å¯èª­æ€§
            3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
            5. SOLIDåŸå‰‡

            å‡ºåŠ›è¦ä»¶:
            - has_critical: boolean
            - has_major: boolean
            - body: stringï¼ˆGitHubã«æŠ•ç¨¿ã™ã‚‹æœ¬æ–‡ã€‚Critical/Major/Minor/è‰¯ã„ç‚¹ã®è¦‹å‡ºã—ã‚’å«ã‚ã‚‹ï¼‰
          claude_args: |
            --dangerously-skip-permissions
            --json-schema '{"type":"object","properties":{"has_critical":{"type":"boolean"},"has_major":{"type":"boolean"},"body":{"type":"string"}},"required":["has_critical","has_major","body"]}'
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.G_TOKEN }}

      - name: GitHub PRã¸ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_target'
        env:
          GITHUB_TOKEN: ${{ secrets.G_TOKEN }}
        run: |
          OUTPUT='${{ steps.review.outputs.structured_output }}'
          REVIEW_BODY=$(echo "$OUTPUT" | jq -r '.body')
          PR_NUMBER="${{ github.event.pull_request.number }}"

          gh api \
            --method POST \
            /repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            -f body="$REVIEW_BODY"

      - name: Critical/Majorå•é¡ŒãŒã‚ã‚Œã°Issueã‚’ä½œæˆ
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_target'
        env:
          GITHUB_TOKEN: ${{ secrets.G_TOKEN }}
        run: |
          OUTPUT='${{ steps.review.outputs.structured_output }}'
          HAS_CRITICAL=$(echo "$OUTPUT" | jq -r '.has_critical')
          HAS_MAJOR=$(echo "$OUTPUT" | jq -r '.has_major')
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"

          if [ "$HAS_CRITICAL" = "true" ] || [ "$HAS_MAJOR" = "true" ]; then
            ISSUE_TITLE="ğŸ¤– AIãƒ¬ãƒ“ãƒ¥ãƒ¼: ${PR_TITLE} (#${PR_NUMBER}) - è¦ä¿®æ­£"
            ISSUE_BODY="## AIãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

            PR #${PR_NUMBER} ã€Œ${PR_TITLE}ã€ ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§é‡å¤§ãªå•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚

            $(echo "$OUTPUT" | jq -r '.body')

            ---
            - PR: #${PR_NUMBER}
            - è‡ªå‹•ä½œæˆè€…: Claude AI Coder"

            gh issue create \
              --title "$ISSUE_TITLE" \
              --body "$ISSUE_BODY" \
              --label "ai-fix,auto-generated"
          fi

  ai-fix-review-comment:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      pull-requests: write

    steps:
      - name: AIã«ã‚ˆã‚‹ä¿®æ­£å®Ÿè¡Œ
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CUSTOM_API_KEY }}
          github_token: ${{ secrets.G_TOKEN }}
          show_full_output: true
          prompt: |
            ã€PRä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã€‘ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…ƒã«ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
            ä¿®æ­£å¾Œã¯ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ:
            ${{ github.event.review.body }}
          claude_args: |
            --dangerously-skip-permissions
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.G_TOKEN }}
