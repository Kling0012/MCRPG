name: Claude AI Coder

on:
  workflow_dispatch:
  push:
    branches:
      - Local50
      - main
  issues:
    types: [labeled]
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]

jobs:
  ai-fix:
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'ai-fix') && !contains(github.event.issue.labels.*.name, 'auto-generated')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      issues: write
      pull-requests: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude ã« Issue å¯¾å¿œã‚’ä¾é ¼
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CUSTOM_API_KEY }}
          github_token: ${{ github.token }}
          show_full_output: ${{ vars.CLAUDE_SHOW_FULL_OUTPUT == 'true' }}
          prompt: |
            ã€è‡ªå¾‹å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã€‘ã‚ãªãŸã¯éå¯¾è©±ç’°å¢ƒã® GitHub Actions ä¸Šã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚
            - äººé–“ã¨ã®ä¼šè©±ã¯ä¸å¯èƒ½ã§ã™ã€‚è³ªå•ã›ãšè‡ªå·±å®Œçµã—ã¦ãã ã•ã„ã€‚
            - ä¿®æ­£å¾Œã¯å¿…ãšãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã€PRã‚’ä½œæˆã—ã¦çµ‚äº†ã—ã¦ãã ã•ã„ã€‚
            - ä½œæ¥­å®Œäº†å¾Œã€å¿…ãš git push ã—ã¦ãã ã•ã„ã€‚

            æŒ‡ç¤ºå†…å®¹: Issue #${{ github.event.issue.number }} ${{ github.event.issue.title }}
          claude_args: |
            --dangerously-skip-permissions
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
          GITHUB_TOKEN: ${{ github.token }}

  ai-review:
    if: (github.event_name == 'pull_request_target') && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
      issues: write
    env:
      ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
      ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
      GH_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ github.token }}
      GITHUB_TOKEN: ${{ github.token }}

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        if: github.event_name != 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude ã« PR ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚‚å«ã‚€ï¼‰
        if: github.event_name != 'push' && github.event_name == 'pull_request_target'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CUSTOM_API_KEY }}
          github_token: ${{ github.token }}
          show_full_output: ${{ vars.CLAUDE_SHOW_FULL_OUTPUT == 'true' }}
          track_progress: true
          use_sticky_comment: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ã‚ãªãŸã¯ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦æ—¥æœ¬èªã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚

            å¿…é ˆè¦ä»¶:
            - `gh pr diff ${{ github.event.pull_request.number }} --repo ${{ github.repository }}` ã¨ `gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }}` ã‚’ä½¿ã£ã¦å¤‰æ›´å†…å®¹/æ–‡è„ˆã‚’æŠŠæ¡ã™ã‚‹
            - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ `gh pr review ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --comment -b "<æœ¬æ–‡>"` ã§PRã«ç›´æ¥æŠ•ç¨¿ã™ã‚‹ï¼ˆ`gh api /issues/.../comments` ã¯ä½¿ã‚ãªã„ï¼‰

            - æŒ‡æ‘˜ãŒã‚ã‚‹å ´åˆã¯ã€é‡å¤§åº¦ã«é–¢ä¿‚ãªã Issue ã‚’è‡ªå‹•ä½œæˆã—ã¦ï¼ˆ`ai-fix,auto-generated` ãƒ©ãƒ™ãƒ«ä»˜ä¸ï¼‰
              - ã‚¿ã‚¤ãƒˆãƒ«ä¾‹: `ğŸ¤– AIãƒ¬ãƒ“ãƒ¥ãƒ¼: <PRã‚¿ã‚¤ãƒˆãƒ«> (#<PRç•ªå·>) - ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—`
              - æœ¬æ–‡ã«PRãƒªãƒ³ã‚¯ï¼ˆ`${{ github.server_url }}/${{ github.repository }}/pull/${{ github.event.pull_request.number }}`ï¼‰ã¨ã€æŒ‡æ‘˜è¦ç´„ã€å¯¾å¿œæ¡ˆã‚’å«ã‚ã‚‹

            ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:
            1. ãƒã‚°ã®å¯èƒ½æ€§
            2. å¯èª­æ€§
            3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
            5. SOLIDåŸå‰‡
            6. ä»–å±é™ºæ€§ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰

            PRã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã®æ§‹æˆ:
            - è¦‹å‡ºã—: Critical / Major / Minor / è‰¯ã„ç‚¹
            - å¿…ãšè©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ã¨å‰å¾Œè¡Œã®æ ¹æ‹ ã‚’æ·»ãˆã‚‹
          claude_args: |
            --dangerously-skip-permissions
            --allowedTools "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr review:*),Bash(gh issue create:*),Bash(gh issue edit:*),Bash(gh issue comment:*),Bash(gh api:*)"

<<<<<<< HEAD
=======
  ai-fix-review-comment:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      pull-requests: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: AIã«ã‚ˆã‚‹ä¿®æ­£å®Ÿè¡Œ
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CUSTOM_API_KEY }}
          github_token: ${{ github.token }}
          show_full_output: ${{ vars.CLAUDE_SHOW_FULL_OUTPUT == 'true' }}
          prompt: |
            ã€PRä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã€‘ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…ƒã«ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
            ä¿®æ­£å¾Œã¯ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ:
            ${{ github.event.review.body }}
          claude_args: |
            --dangerously-skip-permissions
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
          GITHUB_TOKEN: ${{ github.token }}
>>>>>>> 1eb39e0009fd12fd404a5a908674a2575b84267d
