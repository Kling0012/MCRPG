# ローカルWebエディタ 最終設計案

**日付**: 2026-01-16
**チーム**: ClaudeCode (統率), Codex (技術), Gemini (UX), iFlow (プロセス)

---

## 合意形成されたアーキテクチャ

### 基本方針
- **サーバーレス**: 単一HTMLファイル（CDNライブラリ使用）
- **ハイブリッドUI**: フォームモード（基本）+ YAMLモード（上級者）切り替え
- **YAML最優先**: YAMLファイルを直接読み書きできることを最優先
- **安全設計**: 初心者でもストレスなく使えるUI/UX

---

## 1. 技術スタック

| コンポーネント | 選択 |
|----------------|------|
| **パースライブラリ** | js-yaml (CDN) |
| **バリデーション** | ajv (JSON Schema) or 手書きバリデータ |
| **状態管理** | 単一JSONオブジェクト `state` |
| **永続化** | LocalStorage (30秒間隔自動保存) |
| **ファイルI/O** | File API (読込), Blob API (書込) |

---

## 2. UIレイアウト（3ペイン）

```
┌─────────────────────────────────────────────────────────────┐
│ ヘッダー: [新規] [インポート] [エクスポート] [フォーム/YAML切替] │
├──────────────────────┬──────────────────────────────────────┤
│ 左: フォームモード    │ 右: リアルタイムプレビュー             │
│ (基本/詳細タブ)       │ (ゲーム内表示をシミュレート)          │
│                      │                                      │
│ [基本情報]           │ **ファイアボール**                    │
│ ID: fireball        │ (ID: fireball)                        │
│ 名前: ファイアボール │ MP: 5 消費                            │
│ ダメージ: 10         │ 10の炎ダメージを与える                │
│                      │                                      │
│ [>] ステータス        │                                      │
│ [>] 発動条件          │                                      │
├──────────────────────┴──────────────────────────────────────┤
│ YAMLモード（トグル表示）                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ id: fireball                                              │ │
│ │ name: ファイアボール                                       │ │
│ │ damage: 10                                                │ │
│ │ ...                                                       │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. データフロー

```
[YAML/JSONファイル]
       ↓ File API
   [パーサー層]
   (js-yaml or JSON.parse)
       ↓
   [正規化モデル state] ←→ LocalStorage (30秒自動保存)
       ↓
   ┌─────┴─────┐
   ↓           ↓
[フォーム]   [YAMLエリア]
   ←→ 双方向同期 ←→
   ↓
[プレビュー]
```

---

## 4. プログレッシブ開示（RPGClass 20+項目のグルーピング）

| グループ | 項目例 | デフォルト状態 |
|----------|--------|---------------|
| **基本情報** | id, name, displayName, description, icon | 展開 |
| **ステータス** | maxLevel, hp, mp, attack, defense, manaRegen | 折りたたみ |
| **上級設定** | expDiminish, statGrowth, nextRankClassId | 折りたたみ |
| **スキル関連** | availableSkills, passiveBonuses | 折りたたみ |

---

## 5. バリデーション設計

### 2層構成
1. **構造バリデーション**: 必須/型/範囲チェック（リアルタイム）
2. **業務ルールバリデーション**: スキル数上限、依存関係チェック

### エラー表示パターン
| 種類 | UI |
|------|-----|
| 単一フィールドエラー | インライン表示（赤枠+メッセージ） |
| 論理エラー | ヘッダー通知（ノンブロッキング） |
| YAML構文エラー | YAMLエリア下部のコンソールパネル |

---

## 6. 技術的懸念点と対策

| 懸念点 | 対策 |
|--------|------|
| フォーム↔YAML同期競合 | `isSyncing` フラグ、デバウンス |
| YAML安全パース | 任意タグ無効化、XSS防止 |
| 大規模設定パフォーマンス | 部分更新、仮想化 |
| アクセシビリティ | キーボード操作、フォーカス管理、Undo/Redo |
| YAML不正時の挙動 | フォーム読取専用化、エラー箇所提示 |

---

## 7. 成功体験のための工夫

1. **テンプレート提供**: ページ開くと「パンチ」スキルが読み込まれている
2. **最重要項目集中**: 「基本情報」のみ展開済み
3. **即時フィードバック**: 入力するとプレビューが即座に更新
4. **明確なゴール**: 常に表示される「YAMLをダウンロード」ボタン

---

## 合意状態

| エージェント | 状態 |
|------------|------|
| Codex | ✅ 同意 |
| Gemini | ✅ 同意 |
| iFlow | ✅ 既存エディタ拡張を推奨（3,776行コード再利用可能） |

---

## 次のステップ

**既存エディタ拡張方針**（iFlow提案）:

1. **フェーズ1**（最小対応、2-3日）:
   - js-yamlライブラリ追加
   - YAMLファイル読み込み/保存機能
   - 不足フィールド追加（description, icon_material）

2. **フェーズ2**（完全互換）:
   - 高度スキル設定UI
   - YAML構文バリデーション

3. **フェーズ3**（生産性）:
   - Hot Reload連携
   - テンプレート拡張
