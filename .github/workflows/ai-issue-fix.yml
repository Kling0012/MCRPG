name: AI Issue Fix

on:
  issues:
    types: [labeled]
  workflow_dispatch:

jobs:
  ai-issue-fix:
    # NOTE: contains()を使用して全ラベルをチェック（複数ラベル同時付与時の実行漏れを防止）
    if: |
      github.event_name == 'workflow_dispatch' ||
      (contains(github.event.issue.labels.*.name, 'ai-fix') && !contains(github.event.issue.labels.*.name, 'auto-generated'))

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    env:
      CLAUDE_CODE_VERSION: 2.1.9
      GH_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ github.token }}
      GITHUB_TOKEN: ${{ github.token }}
      ANTHROPIC_BASE_URL: ${{ secrets.CUSTOM_BASE_URL }}
      ANTHROPIC_API_KEY: ${{ secrets.CUSTOM_API_KEY }}

    steps:
      - name: Setup Cache
        uses: ./.github/actions/setup-cache

      - name: リポジトリのチェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: セキュリティチェック（auto-generated + 作成者検証）
        id: check-auto-gen
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}

          # auto-generated ラベルチェック（AIレビュー自動作成Issueをスキップ）
          LABELS=$(gh issue view $ISSUE_NUMBER --json labels --jq '.labels[].name' | tr '\n' ',')
          echo "labels=$LABELS" >> $GITHUB_OUTPUT

          if [[ "$LABELS" == *"auto-generated"* ]]; then
            echo "Issue has 'auto-generated' label. Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          # 作成者がリポジトリメンバーかチェック（セキュリティ強化）
          AUTHOR=$(gh issue view $ISSUE_NUMBER --json author --jq '.author.login')
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

          # リポジトリのメンバーシップをチェック
          if ! gh api /repos/${{ github.repository }}/collaborators/$AUTHOR --jq '.permissions.push' > /dev/null 2>&1; then
            echo "❌ Issue author '$AUTHOR' is not a repository member with write access. Blocking for security."
            gh issue comment $ISSUE_NUMBER --body "⚠️ セキュリティチェック: Issue作成者に書き込み権限がないため、自動修正をスキップしました。リポジトリメンバーに権限をリクエストしてください。"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "✅ Security checks passed: auto-generated=false, author=$AUTHOR has write access"
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Claude に Issue 修正を依頼（PRへ追コミット）
        if: steps.check-auto-gen.outputs.skip != 'true'

        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CUSTOM_API_KEY }}
          github_token: ${{ github.token }}
          track_progress: ${{ github.event_name == 'issues' }}
          use_sticky_comment: ${{ github.event_name == 'issues' }}
          show_full_output: ${{ vars.CLAUDE_SHOW_FULL_OUTPUT == 'true' }}
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}

            あなたは自律実行エージェントです。Issue本文の「---」ブロックから PR_NUMBER/PR_BRANCH/BASE_BRANCH/FIX_MODE/PR_URL を読み取り、修正をPRに追コミットしてください。

            実行手順:
            1) `gh pr view <PR_NUMBER> --repo ${{ github.repository }}` と `gh pr diff <PR_NUMBER> --repo ${{ github.repository }}` で内容把握
            2) `gh pr checkout <PR_NUMBER> --repo ${{ github.repository }}` でPRブランチをチェックアウト
            3) 修正 → `git add` → `git commit` → `git push`（同一リポジトリ内PRなので原則 push で直接更新）
            4) Issueに「何を直したか」「PR URL」「主なコミット/差分」を必ずコメント
            5) pushできた場合は Issue を close し、`ai-fix` ラベルが付いていれば外す（ループ防止）
               ※ push 後は PR の synchronize で ai-review が自動再実行されるため、手動で再レビュー起動はしない

            例外:
            - どうしても push できない場合のみ、新規ブランチ+新規PR（new_pr）を作ってリンクを残す
          claude_args: |
            --dangerously-skip-permissions
            --allowedTools "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr checkout:*),Bash(gh pr create:*),Bash(gh issue comment:*),Bash(gh issue edit:*),Bash(git status:*),Bash(git diff:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git checkout:*),Bash(git branch:*),Bash(git log:*),Bash(git fetch:*),Bash(git reset:*),Bash(gh api:*)"
